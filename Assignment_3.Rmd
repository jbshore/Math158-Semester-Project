---
title: "Assignment 3"
author: "Jacob Shore & Derek Huang"
date: "March 26, 2018"
output: html_document
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 3.5, fig.height = 3.5, echo = TRUE)
library(dplyr)
library(ggplot2)
library(infer)
library(skimr)
library(broom)
library(readr)
options(digits=5)

library(readr)
kc_house_data <- read_csv("~/Downloads/kc_house_data.csv")
housing <- kc_house_data
set.seed(12897312)
housing2 <- housing[sample(nrow(housing), 1000),]
```

Introduction: Our dataset describes over 21,000 homes sold between May 2014 and May 2015 in King County, WA (Seattle area). The initial dataset consists of 19 variables: price, the number of bedrooms/bathrooms, the size of the house/parking lot/basement, the number of floors, whether waterfront or not, overall condition/grade, built year, renovation year, zip code and latitude/longitude coordinate. 

We are interested in predicting the price of a house given all the other variables. In this report, we are going to look at the relationships between price (response variable) and sqft_living, sqft_lot, condition, view, long, lat (explanatory variables) since these are the variables that would affect the price intuitively. We have randomly selected 1,000 of the 21,613 observations to be included in our model analysis. 
 
To fit the regression model, we have selected the following explanatory variables:
sqft_living: the size of the house in square foot
sqft_lot: the size of the property in square foot
condition: condition of the house in a scale of 1-10
view: how good the view is from the house
long: longitude of the house
lat: latitude of the house 
All the explanatory variables are numeric.

```{r}
# Model: Predict price using sqft_living, sqft_lot, condition, view, long, lat
library(GGally)
ggpairs(housing2,
columns = c("price", "sqft_living", "sqft_lot", "condition", "view", "lat", "long"))

```

Looking at the pairs plot, apart from price and sqft_living, we don't see two highly correlated explanatory variables. As far as quadratic term and log transformation go, We did log on sqft_lot because all of them are bunched up around smaller values. We did log on price to get rid of heteroskedasticity. This is more apparent below when we look at residuals.

```{r}
# testing interaction

inter.model <- lm(log(price) ~ (sqft_living + log(sqft_lot) + condition + view + lat + long)^2, data=housing2)
no.inter.model <- lm(log(price) ~ sqft_living + log(sqft_lot) + condition + view + lat + long, data=housing2)
summary(inter.model)
summary(no.inter.model)
```

In order to figure out which variables are interacting, we compare the non-interacting model with the interacting model, and since log(sqft_lot) and long are insignificant so the interaction terms that we keep are sqft_living:condition, sqft_living:view, and view:lat (among significant variables). 


Looking at the coefficients in non-interaction model, sqft_living, condition, view, and lat are significant. 

```{r}
# Fit our model

# Model that we are using
full.model <- lm(log(price) ~ (sqft_living + log(sqft_lot) + condition + view + lat + long + sqft_living*condition + sqft_living*view + view*lat), data=housing2)

# reduced model
reduced.model <- lm(log(price) ~ (sqft_living + lat + sqft_living*view + sqft_living*condition), data=housing2)

anova(full.model, reduced.model)
```

We'll report the reduced (smaller) model. Even though R2-adj is slightly lower, the nested f-test was not significant (p-val = .11).
Reduced: R2 = .7094 R2.adj = .7076
Full: R2 = .7111 R2.adj = .7085

We refer to the reduced model from now on as "the model"

R2 value tells us that around 70% of the variability in the explanatory variables can be explained by the linear model. This doesn't necessarily mean that it is guaranteed that the model will accurately describe
the population because there are some factors that can't be controled in the model and the model is based on subjective premises. 

```{r}
# Residual plot
augment(reduced.model) %>%
ggplot( aes(x=.fitted, y=.std.resid)) +
geom_point() +
geom_hline(yintercept = 0) + labs(x = "Fitted", y = "Std. Resid.", title = "Standardized Residual Plot")
```
Looks good

```{r}
del.stud.resids <- rstudent(full.model)
# Bonf. critical value is 
# t(1-alpha/2n, n-p-1)
Bon.alpha <- .01/length(del.stud.resids)
Bon.crit.upper <- qt(1-Bon.alpha/2, length(del.stud.resids)-1-4)
Bon.crit.lower <- qt(Bon.alpha/2, length(del.stud.resids)-1-4)

outliers.y <- subset(del.stud.resids, (del.stud.resids < Bon.crit.lower) | (del.stud.resids > Bon.crit.upper))
outliers.y.sort <- sort(abs(outliers.y), decreasing = TRUE)

hat.diags <- hatvalues(reduced.model)
# considered to be outlier if it is 
# more than twice mean leverage value
mean.lev <- mean(hat.diags)
lev.crit <- 2*mean.lev
outliers.x <- subset(hat.diags, hat.diags > lev.crit)
outliers.x.sort <- sort(outliers.x, decreasing = TRUE)

# Dffits
#dfbetas
#cook's distance
```

No outliers in Y direction. 100 outliers in X direction. 


```{r}
# select variables using forward selection approach 

add1(lm(price~1, data=housing2), price ~ sqft_living + sqft_lot + condition + view + lat + long, test="F")
# sqft_living is the most significant variable (lowest p value & highest F value)
add1(lm(price ~ sqft_living, data=housing2), price ~ sqft_living + sqft_lot + condition + view + lat + long, test="F")
# view is the second most significant variable after sqft_living
add1(lm(price ~ sqft_living + view, data=housing2), price ~ sqft_living + sqft_lot + condition + view + lat + long, test="F")
# next is lat 
add1(lm(price ~ sqft_living + view + lat, data=housing2), price ~ sqft_living + sqft_lot + condition + view + lat + long, test="F")
# lat is followed by condition
add1(lm(price ~ sqft_living + view + lat + condition, data=housing2), price ~ sqft_living + sqft_lot + condition + view + lat + long, test="F")
# then by long
```
With forward selection, We select sqft_living, view, lat, condition, long (in order of significance). 


It makes sense that sqft-living is the most significant variables since the bigger the house, the more expensive it is. Our model analysis tells us that people tend to care about the size of the house more than the size of the property because when you are living in a house, the area that matters is going to be the house, the grass area in the front, not so much. We thought sqft-living and sqft_lot would be highly correlated and thus one of them could be taken out. But that is not the case in the model.

However, it is surprising that latitude is siginificant while longitude is not. We think that it is because usually the same amount of change in latitude has a bigger impact on the neighborhood than in longitude. 
