---
title: "Final_Assignment"
author: "Jacob Shore & Derek Huang"
date: "April 26, 2018"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(fig.width = 3.5, fig.height = 3.5, echo = TRUE)
library(dplyr)
library(ggplot2)
library(infer)
library(skimr)
library(broom)
library(readr)
options(digits=5)

library(readr)
kc_house_data <- read_csv("~/Downloads/kc_house_data.csv")
housing <- kc_house_data
set.seed(12897312)
housing2 <- housing[sample(nrow(housing), 1000),]
housing2 <- housing2 %>% dplyr::select(-c(id, date, yr_renovated, sqft_living15, sqft_lot15))
housing2$zipcode <- as.factor(housing2$zipcode)
```

# Introduction

# LASSO and RR

```{r}
# Ridge Regression
require(ISLR); require(glmnet)
set.seed(232352)

housing2.RR <- housing2 %>% select(-price)
price.RR <- housing2$price

# set up lambda grid
lambda.grid =10^seq(5,-2, length =100)

# build the model
housing.ridge <- glmnet(data.matrix(housing2.RR), price.RR, alpha=0,
lambda = lambda.grid, standardize=TRUE)

housing.ridge.cv <- cv.glmnet(data.matrix(housing2.RR), price.RR, alpha=0,
lambda = lambda.grid, standardize=TRUE)
cat("The value of lambda that minimizes cv error is", housing.ridge.cv$lambda.min)

plot(housing.ridge.cv)
abline(v=log(housing.ridge.cv$lambda.min), col="green")

colors <- rainbow(8)
plot(housing.ridge, xvar="lambda", xlim=c(-6,15),col=colors)
abline(v=log(housing.ridge.cv$lambda.min))
abline(h=0, lty=2)
text(rep(-6.5, 9), coef(housing.ridge)[-1,length(lambda.grid)], colnames(housing2.RR)[-9], pos=4, col=colors)

min.index <- which(lambda.grid == housing.ridge.cv$lambda.min)
# lambda ~ 148.5 or index 41
ridge.coefs <- coef(housing.ridge)[,min.index]
ridge.coefs <- ridge.coefs[-1]
plot(ridge.coefs)
```

```{r}
# LASSO
housing.lasso <- glmnet(data.matrix(housing2.RR), price.RR, alpha=1,
lambda = lambda.grid, standardize=TRUE)

housing.lasso.cv <- cv.glmnet(data.matrix(housing2.RR), price.RR, alpha=1,
lambda = lambda.grid, standardize=TRUE)
cat("The value of lambda that minimizes cv error is", housing.lasso.cv$lambda.min)

plot(housing.lasso.cv)
abline(v=log(housing.lasso.cv$lambda.min), col="green")

colors <- rainbow(8)
plot(housing.lasso, xvar="lambda", xlim=c(-6,15),col=colors)
abline(v=log(housing.lasso.cv$lambda.min))
abline(h=0, lty=2)
text(rep(-6.5, 9), coef(housing.lasso)[-1,length(lambda.grid)], colnames(housing2.RR)[-9], pos=4, col=colors)

min.index.las <- which(lambda.grid == housing.lasso.cv$lambda.min)
# lambda ~ .42 or index 77
lasso.coefs <- coef(housing.lasso)[,min.index.las]
lasso.coefs <- lasso.coefs[-1]
plot(lasso.coefs)
```

# Splines and LOESS

```{r}
# Splines
require(splines)

price.rs <- lm(price ~ bs(sqft_living, df=4, degree=3), data=housing2) 
# summary(price.rs)
distance.range <- range(housing2$sqft_living)
sqft_living.grid <- seq(from= distance.range[1], to=distance.range[2], length.out = 50)

price.rs.pred <- predict(price.rs, newdata = data.frame(sqft_living=sqft_living.grid), se=TRUE)


plot(housing2$sqft_living, housing2$price ,xlim=distance.range ,cex =.5, pch=19,
col =" grey40 ", xlab="Square Footage of Living Space", ylab="Price")
title("Cubic Regression Splines on K Knots",outer =F)

knots <- c(3,5,10,40)
color = 0
SSE.vec.rs <- c()
for(i in knots){
  var.degree <- lm(price ~ bs(sqft_living, df=i, degree=3), data=housing2) 
  SSE <- sum(var.degree$residuals^2)
  SSE.vec.rs[i] <- SSE
  var.pred <- predict(var.degree, newdata= data.frame(sqft_living=sqft_living.grid), se=TRUE)
  color = color+1
  lines(sqft_living.grid, var.pred$fit, lwd=2, col =color)
}
legend(6000,2000000,c(3,5,10,40), lty=c(1,1), lwd=c(2.5,2.5),col=c(1,2,3,4), title = "# Knots")
SSE.vec.rs[!is.na(SSE.vec.rs)]

# CV it's 3
```

```{r}
# LOESS
distance.range <- range(housing2$sqft_living)
sqft_living.grid <- seq(from= distance.range[1], to=distance.range[2], length.out = 50)

plot(housing2$sqft_living, housing2$price ,xlim=distance.range ,cex =.5, pch=19,
col =" grey40 ", xlab="Square Footage of Living Space", ylab="Price")
title("Local Regression (loess)",outer =F)

span <- c(.1,.3,.6,.9)
color = 0
SSE.vec.lor <- c()
for(i in span){
price.lor <- loess(price ~ sqft_living, span=i, data=housing2)
SSE <- sum(price.lor$residuals^2)
  SSE.vec.lor[i*10] <- SSE
price.lor.pred <- predict(price.lor, newdata = data.frame(sqft_living=sqft_living.grid), se=TRUE)
color=color+1
lines(sqft_living.grid, price.lor.pred$fit ,lwd =2, col =color)
}
legend(6000,2000000,c(.1,.3,.6,.9), lty=c(1,1), lwd=c(2.5,2.5),col=c(1,2,3,4), title = "Span")
SSE.vec.lor[!is.na(SSE.vec.lor)]


# CV is .9
```

But these aren't all that interesting, since square footage of living space is already a really solid single variable predictor of price. Let's look at a variable which has less of a classic linear relationship with price but still has some interesting predictive properties --- latitude. In previous assignments, latitude has always shown up as a significant predictor, but the relationship between latitude and price is not that straightforward.

```{r}
# Splines
price.rs <- lm(price ~ bs(lat, df=4, degree=3), data=housing2) 
# summary(price.rs)
distance.range <- range(housing2$lat)
lat.grid <- seq(from= distance.range[1], to=distance.range[2], length.out = 50)

price.rs.pred <- predict(price.rs, newdata = data.frame(lat=lat.grid), se=TRUE)


plot(housing2$lat, housing2$price ,xlim=distance.range ,cex =.5, pch=19,
col =" grey40 ", xlab="Square Footage of Living Space", ylab="Price")
title("Cubic Regression Splines on K Knots",outer =F)

knots <- c(3,5,10,40)
color = 0
SSE.vec.rs <- c()
for(i in knots){
  var.degree <- lm(price ~ bs(lat, df=i, degree=3), data=housing2) 
  SSE <- sum(var.degree$residuals^2)
  SSE.vec.rs[i] <- SSE
  var.pred <- predict(var.degree, newdata= data.frame(lat=lat.grid), se=TRUE)
  color = color+1
  lines(lat.grid, var.pred$fit, lwd=2, col =color)
}
legend(47.2,3000000,c(3,5,10,40), lty=c(1,1), lwd=c(2.5,2.5),col=c(1,2,3,4), title = "# Knots")
SSE.vec.rs[!is.na(SSE.vec.rs)]

# CV it's 3
```

```{r}
# LOESS
distance.range <- range(housing2$lat)
lat.grid <- seq(from= distance.range[1], to=distance.range[2], length.out = 50)

plot(housing2$lat, housing2$price ,xlim=distance.range ,cex =.5, pch=19,
col =" grey40 ", xlab="Square Footage of Living Space", ylab="Price")
title("Local Regression (loess)",outer =F)

span <- c(.1,.3,.6,.9)
color = 0
SSE.vec.lor <- c()
for(i in span){
price.lor <- loess(price ~ lat, span=i, data=housing2)
SSE <- sum(price.lor$residuals^2)
  SSE.vec.lor[i*10] <- SSE
price.lor.pred <- predict(price.lor, newdata = data.frame(lat=lat.grid), se=TRUE)
color=color+1
lines(lat.grid, price.lor.pred$fit ,lwd =2, col =color)
}
legend(47.2,3000000,c(.1,3.,.6,.9), lty=c(1,1), lwd=c(2.5,2.5),col=c(1,2,3,4), title = "Span")
SSE.vec.lor[!is.na(SSE.vec.lor)]
```


# Conclusion

# Generalized Additive Models
http://www.nrcse.washington.edu/NordicNetwork/GAMlecture.pdf

# Lack of Fit (MLR)

# Inverse Predictions

# Summary
